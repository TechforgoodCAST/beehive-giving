= content_for :title, "Hidden Fund [#{@fund.hashid}]"

%header
  = cell :v2_navbar, @current_user
  = cell :breadcrumb, (@proposal.title? ? @proposal.title : 'Current proposal').upcase_first => nil, 'Funds' => proposal_funds_path(@proposal), 'Hidden funder' => nil, 'Hidden fund' => proposal_fund_path(@proposal, @fund)

:javascript
  mixpanel.track('View Fund Page', { "Fund": "#{@fund.hashid}" });
  mixpanel.identify("#{@current_user.id}");

%main
  .maxw1080.mx-auto.px20.flex.flex-wrap
    %aside.perc25.md.px20.mb40
      = render partial: 'card', locals: { fund: @fund }
      = render partial: 'proposals/card', locals: { context: 'muted' }

    %section.perc75.md.mb80.px20
      %section
        = link_to 'Reveal Fund Identity', reveals_path(fund: @fund), method: :post, class: 'button white bg-blue caps shadow mb20'

        %h1.light.italic Hidden Fund
        .fs15.lh20.mid-gray.redacted= scramble_name(@fund.funder.name)

        %p.fs15.mt15.lh20
          = cell(:fund_insight, @fund, proposal: @proposal).call(:themes)

      %hr.my40

      %section
        .mb20
          %h2.light Summary

        .mb20.markdown
          = raw @fund.description_redacted

        - if @fund.period_end.present? && @fund.period_end > 3.years.ago
          %small.slate
            = cell(:fund_insight, @fund).call(:data_source)
          .slate.fs15.my10
            = period(@fund)

        - unless @fund.open_call?
          .bg-silver.rounded.shadow.fs18.lh22.p10.mb20
            .bold.caps.mb10.fs15 Unsolicited applications
            Please note this fund does not accept unsolicited applications. Please read the fund guidance for more information.

        %ul.list.pl30
          = cell(:fund_insight, @fund).call(:amount)
          = cell(:fund_insight, @fund).call(:duration)
          = cell(:fund_insight, @fund).call(:grant_count)
          = cell(:fund_insight, @fund).call(:award_months)
          = cell(:fund_insight, @fund).call(:countries)
          %li
            = link_to 'Reveal', reveals_path(fund: @fund), method: :post, class: 'bold blue'
            this fund to see recent grants

      %hr.my40

      %section
        .mb20
          %h2.light Eligibility

        = cell(:eligibility_banner, @proposal, fund: @fund).call(:eligible)

        %ul
          - {'Location': 'location', 'Grant amount': 'amount', 'Organisation type': 'org_type', 'Organisation income': 'org_income'}.each do |k, v|
            %li.mb15
              .flex
                %div
                  = cell(:fund_indicators, @fund, proposal: @proposal, criteria: v, large: true).call(:tag)
                %div.ml5
                  = k
              - if @proposal.ineligible_reasons(@fund.slug).include? v
                .bg-red.rounded.shadow.fs14.p10.mb20.mt10.white
                  .bold.caps.mb10 Ineligible
                  = cell(:eligibility_banner, @proposal, fund: @fund).call(v.to_sym)

          %li.mb15
            .flex
              %div
                = cell(:fund_indicators, @fund, proposal: @proposal, criteria: 'quiz', large: true).call(:tag)
              %div.ml5
                Quiz

        %h4.mb10
          Quiz

        %p.mb15
          The following questions have been set by
          
          = succeed ',' do
            %span.mid-gray.redacted= scramble_name(@fund.funder.name)
          complete them to see if you are eligible for their
          %span.mid-gray.redacted= scramble_name(@fund.short_name)
          fund.

        = simple_form_for :check, url: eligibility_proposal_fund_path(@proposal, @fund), method: :patch do |f|

          - if @proposal.ineligible_reasons(@fund.slug).include? 'quiz'
            .bg-red.rounded.shadow.fs14.p10.mb20.white
              = cell(:eligibility_banner, @proposal, fund: @fund).call(:quiz)
            
          = f.hidden_field :return_to, :value => 'fund'
          = cell(:quiz, @fund, quiz_type: 'Restriction', proposal: @proposal, f: f, 
                                groups: {'Proposal' => 'Is your funding proposal for?', 
                                        'Recipient' => 'Is your organisation?'}).call(:show)

      %hr.my40

      - if @proposal.eligible?(@fund.slug)
        %section
          .mb40
            %h2.light Apply
          
          = link_to 'Application form', apply_proposal_fund_path(@proposal, @fund), class: "button white bg-blue caps shadow mb40"

      - else
        %section.muted
          .mb40
            %h2.light Apply

          - unless @fund.open_call?
            .bg-silver.rounded.shadow.fs18.lh22.p10.mb20
              .bold.caps.mb10.fs15 Unsolicited applications
              Please note this fund does not accept unsolicited applications. Please read the fund guidance for more information.

          .button.white.bg-blue.caps.shadow.mb40 Application form
